name: Push

on:
  push:
    branches:
      - main
  pull_request:

permissions:
  packages: write

# TODO:
# 1. split out the push action to separate action
# 2. add caching based on fork behaviour, use GHA cache or registry..

jobs:
  build_call:
    uses: ./.github/workflows/build.yml

  build:
    runs-on: ubuntu-latest

    outputs:
      tag: ${{ steps.build.outputs.tag }}

    steps:
      - uses: actions/checkout@v4

      - id: context
        uses: ./.github/actions/context

      - uses: ./.github/actions/build
        id: build
        with:
          node_env: production
          latest: ${{ steps.context.outputs.is_release_master }}
          push: ${{ steps.context.outputs.is_fork == 'false' }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

  download:
      runs-on: ubuntu-latest
      needs: [build]

      steps:
        - uses: actions/checkout@v4

        - uses: ./.github/actions/run
          with:
            tag: ${{ needs.build.outputs.tag }}
            run: |
              echo "Hello world"
              npm run test


